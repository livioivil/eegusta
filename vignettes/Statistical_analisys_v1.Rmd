---
title: "Statistical Analisys"
author: "Livio Finos and Antonio Maffei"
date: "09/05/2022"
output: 
  html_document: 
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)

library(tidyverse)

#see also Import_and_visualize_GroupLevel.Rmd
load(file="../data-raw/all_erp.Rdata")

#elec_position <- import_chans("canali.ced")
```


## Prepare the data.frame ready to be modeled
Starting from the list of all the individual data files (`r all_erp`), we do the following steps:
- Bind the list in a single data.frame
- Create two virtual channels (ROI - Region Of Interest) for the left and right posterior electrodes
- Split the variable `r condition`, into two new variables to be able to model the type of stimulus (Car or Face) and its visibility (Normal or Scrambled)
- Filter the data into the time window of interest (140-180 ms)
- Summarise the mean amplitude for each subject, condition and ROI

```{r}

D = all_erp %>% 
  lapply(., pivot_longer, -time, names_to = "elec", values_to = "amplitude") %>% 
  bind_rows(.id = "tmp_ID") %>% 
  separate(tmp_ID, c("ID", "condition"), "_") %>% 
  # Creates the ROI (two posterior ROI, one on the left and one on the right)
  mutate(roi = case_when(
    elec %in% c("PO8", "O2", "P8") ~ "pos_dx",
    elec %in% c("PO7", "O1", "P7") ~ "pos_sx",
  )) %>%
  drop_na() %>%
  # Creates two new variables stimulus and modality. Stimulus contains info about the type 
  # of stimulus (Car or Face). modality contains info about the visbility (Normal or Scrambled)
  mutate(
    modality = case_when(
      str_detect(condition, "Scrambled") ~ "Scrambled",
      !str_detect(condition, "Scrambled") ~ "Normal"
    ),
    stimulus = case_when(
      str_detect(condition, "Cars") ~ "Cars",
      str_detect(condition, "Faces") ~ "Faces"
    )
  ) %>% 
  # Removes the variable condition. We don't need it anymore!
  select(-condition) %>%
  # Filter the time points of interest
  filter(time < 180, time > 140) %>% 
  # Creates mean value per each ID, roi, stimulus and modality
  group_by(ID, stimulus, modality, roi) %>%
  summarise(M = mean(amplitude)) %>% 
  ungroup()

head(D)

```

